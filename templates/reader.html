<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <title>ğŸ“– ì±… ì½ê¸° - English Book Tutor</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <div class="header-content">
                <a href="/library" class="back-btn">â† ë„ì„œê´€</a>
                <h1 class="page-title" id="bookTitle">ì±… ì½ê¸°</h1>
                <div class="level-badge small">
                    <span class="level-text">Lv.<span id="userLevel">1</span></span>
                </div>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="reader-container">
            <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
            <div class="reader-controls">
                <a href="/game/{{ book_id }}" class="control-btn" style="text-decoration: none; background: #4F46E5; color: white;">
                    ğŸ® ê²Œì„ ëª¨ë“œ
                </a>
                <button class="control-btn" onclick="toggleAutoRead()">
                    <span id="autoReadIcon">â–¶ï¸</span> ìë™ ì½ê¸°
                </button>
                <button class="control-btn" onclick="stopSpeech()">
                    â¹ï¸ ì •ì§€
                </button>
                <button class="control-btn" onclick="changeSpeechRate(0.8)">
                    ğŸ¢ ëŠë¦¬ê²Œ
                </button>
                <button class="control-btn" onclick="changeSpeechRate(1.0)">
                    ğŸš¶ ë³´í†µ
                </button>
                <button class="control-btn" onclick="changeSpeechRate(1.3)">
                    ğŸƒ ë¹ ë¥´ê²Œ
                </button>
                <button class="control-btn" onclick="toggleTranslation()">
                    ğŸŒ ë²ˆì—­ í† ê¸€
                </button>
            </div>

            <!-- ì§„ë„ í‘œì‹œ -->
            <div class="progress-section" style="margin-bottom: 1.5rem;">
                <div class="exp-bar-container">
                    <div class="exp-bar">
                        <div class="exp-fill" id="readingProgress" style="width: 0%; background: linear-gradient(90deg, #4F46E5, #7C3AED);"></div>
                    </div>
                    <div class="exp-text" id="progressText" style="color: #6B7280;">í˜ì´ì§€ 0 / 0</div>
                </div>
            </div>

            <!-- ì±… ë‚´ìš© -->
            <div class="reading-content" id="readingContent">
                <div class="loading">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <!-- ë²ˆì—­ ë°•ìŠ¤ -->
            <div class="translation-box" id="translationBox" style="display: none;">
                <h4 style="margin-bottom: 0.5rem;">ğŸ“ ë²ˆì—­</h4>
                <p id="translationText">ë¬¸ì¥ì„ í´ë¦­í•˜ë©´ ë²ˆì—­ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                <button class="btn btn-secondary" onclick="addCurrentToVocab()" style="margin-top: 0.5rem; width: 100%;">
                    ğŸ“ ë‹¨ì–´ì¥ì— ì¶”ê°€
                </button>
            </div>

            <!-- í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="page-navigation" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="previousPage()" id="prevBtn" style="flex: 1;">
                    â† ì´ì „ í˜ì´ì§€
                </button>
                <button class="btn btn-primary" onclick="nextPage()" id="nextBtn" style="flex: 1;">
                    ë‹¤ìŒ í˜ì´ì§€ â†’
                </button>
            </div>
        </main>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let currentBook = null;
        let currentPage = 0;
        let pages = [];
        let isAutoReading = false;
        let speechRate = 1.0;
        let currentSentence = null;
        let showTranslation = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        loadUserProfile();
        loadBook();

        async function loadBook() {
            const bookId = {{ book_id }};
            
            try {
                const response = await fetch(`/api/books/${bookId}`);
                currentBook = await response.json();
                
                document.getElementById('bookTitle').textContent = currentBook.title;
                
                // ì±… ë‚´ìš©ì„ í˜ì´ì§€ë¡œ ë¶„í•  (1000ìì”©)
                const content = currentBook.content;
                const pageSize = 1000;
                pages = [];
                
                for (let i = 0; i < content.length; i += pageSize) {
                    pages.push(content.substring(i, i + pageSize));
                }
                
                displayPage(0);
                updateProgress();
            } catch (error) {
                console.error('ì±… ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('readingContent').innerHTML = 
                    '<div class="error">ì±…ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        function displayPage(pageNum) {
            if (pageNum < 0 || pageNum >= pages.length) return;
            
            currentPage = pageNum;
            const content = pages[pageNum];
            
            // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ì—¬ í‘œì‹œ
            const sentences = splitIntoSentences(content);
            const contentDiv = document.getElementById('readingContent');
            
            contentDiv.innerHTML = sentences.map((sentence, index) => {
                const highlighted = highlightDifficultWords(sentence);
                return `<span class="sentence" onclick="handleSentenceClick(${index})" data-sentence="${index}">${highlighted}</span>`;
            }).join(' ');
            
            updateProgress();
            
            // í˜ì´ì§€ë¥¼ ì½ì—ˆìœ¼ë¯€ë¡œ ê²½í—˜ì¹˜ ì§€ê¸‰
            if (pageNum > 0) {
                updateReadingProgress(1);
            }
        }

        function updateProgress() {
            const progress = ((currentPage + 1) / pages.length) * 100;
            document.getElementById('readingProgress').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `í˜ì´ì§€ ${currentPage + 1} / ${pages.length}`;
            
            // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage === pages.length - 1;
        }

        function nextPage() {
            if (currentPage < pages.length - 1) {
                displayPage(currentPage + 1);
                window.scrollTo(0, 0);
            } else {
                showNotification('ğŸ‰ ì±…ì„ ëª¨ë‘ ì½ìœ¼ì…¨ìŠµë‹ˆë‹¤!', 'success');
            }
        }

        function previousPage() {
            if (currentPage > 0) {
                displayPage(currentPage - 1);
                window.scrollTo(0, 0);
            }
        }

        async function handleSentenceClick(index) {
            const sentences = document.querySelectorAll('.sentence');
            sentences.forEach(s => s.classList.remove('active'));
            
            const sentence = sentences[index];
            sentence.classList.add('active');
            
            const text = sentence.textContent;
            currentSentence = text;
            
            // ë¬¸ì¥ ì½ê¸°
            speakText(text, speechRate);
            
            // ë²ˆì—­ í‘œì‹œ
            if (showTranslation) {
                const translation = await translateText(text);
                document.getElementById('translationText').textContent = translation;
                document.getElementById('translationBox').style.display = 'block';
            }
        }

        function toggleAutoRead() {
            isAutoReading = !isAutoReading;
            const icon = document.getElementById('autoReadIcon');
            
            if (isAutoReading) {
                icon.textContent = 'â¸ï¸';
                autoReadPage();
            } else {
                icon.textContent = 'â–¶ï¸';
                stopSpeech();
            }
        }

        function autoReadPage() {
            if (!isAutoReading) return;
            
            const content = pages[currentPage];
            speakText(content, speechRate);
            
            // ì½ê¸°ê°€ ëë‚˜ë©´ ë‹¤ìŒ í˜ì´ì§€
            currentUtterance.onend = () => {
                if (isAutoReading && currentPage < pages.length - 1) {
                    nextPage();
                    setTimeout(autoReadPage, 1000);
                } else {
                    isAutoReading = false;
                    document.getElementById('autoReadIcon').textContent = 'â–¶ï¸';
                }
            };
        }

        function changeSpeechRate(rate) {
            speechRate = rate;
            showNotification(`ì†ë„: ${rate === 0.8 ? 'ëŠë¦¬ê²Œ' : rate === 1.0 ? 'ë³´í†µ' : 'ë¹ ë¥´ê²Œ'}`, 'success');
        }

        function toggleTranslation() {
            showTranslation = !showTranslation;
            
            if (!showTranslation) {
                document.getElementById('translationBox').style.display = 'none';
            }
            
            showNotification(showTranslation ? 'ë²ˆì—­ í‘œì‹œ ON' : 'ë²ˆì—­ í‘œì‹œ OFF', 'success');
        }

        async function addCurrentToVocab() {
            if (!currentSentence) {
                showNotification('ë¬¸ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ì„ íƒëœ ë‹¨ì–´ ì°¾ê¸°
            const word = prompt('ë‹¨ì–´ì¥ì— ì¶”ê°€í•  ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!word) return;
            
            const translation = await translateText(word);
            await addToVocabulary(word, translation, currentSentence, currentBook.id);
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') nextPage();
            if (e.key === 'ArrowLeft') previousPage();
            if (e.key === ' ') {
                e.preventDefault();
                toggleAutoRead();
            }
        });
    </script>
</body>
</html>


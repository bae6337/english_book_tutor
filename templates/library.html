<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <title>ğŸ“š ë„ì„œê´€ - English Book Tutor</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <div class="header-content">
                <a href="/" class="back-btn">â† ë’¤ë¡œ</a>
                <h1 class="page-title">ğŸ“š ë„ì„œê´€</h1>
                <div class="level-badge small">
                    <span class="level-text">Lv.<span id="userLevel">1</span></span>
                </div>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- ë‚œì´ë„ í•„í„° -->
            <section class="filter-section">
                <h3 class="section-title">ë‚œì´ë„ ì„ íƒ</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-difficulty="all">ì „ì²´</button>
                    <button class="filter-btn" data-difficulty="beginner">ì´ˆê¸‰ ğŸŒ±</button>
                    <button class="filter-btn" data-difficulty="intermediate">ì¤‘ê¸‰ ğŸ“š</button>
                    <button class="filter-btn" data-difficulty="advanced">ê³ ê¸‰ ğŸ“</button>
                </div>
            </section>

            <!-- ì±… ëª©ë¡ -->
            <section class="books-section">
                <h3 class="section-title">ì¸ê¸° ì˜ì–´ ì›ì„œ</h3>
                <div class="books-grid" id="booksList">
                    <!-- ì±… ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    <div class="loading">ì±… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </section>
        </main>

        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bottom-nav">
            <a href="/" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">í™ˆ</span>
            </a>
            <a href="/library" class="nav-item active">
                <span class="nav-icon">ğŸ“š</span>
                <span class="nav-label">ë„ì„œê´€</span>
            </a>
            <a href="/vocabulary" class="nav-item">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-label">ë‹¨ì–´ì¥</span>
            </a>
            <a href="#" class="nav-item" onclick="alert('ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤!'); return false;">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">í†µê³„</span>
            </a>
        </nav>
    </div>

    <!-- ì±… ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ì±… ì œëª©</h3>
                <button class="modal-close" onclick="closeBookModal()">&times;</button>
            </div>
            <div class="modal-body">
                <img id="modalCover" src="" alt="ì±… í‘œì§€" class="modal-cover">
                <p class="modal-author">ì €ì: <span id="modalAuthor"></span></p>
                <p class="modal-difficulty">ë‚œì´ë„: <span id="modalDifficulty"></span></p>
                <p class="modal-description" id="modalDescription"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBookModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="downloadBtn" onclick="downloadAndReadBook()">
                    ğŸ“¥ ë‹¤ìš´ë¡œë“œ í›„ ì½ê¸°
                </button>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let currentBook = null;
        let currentFilter = 'all';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        loadUserProfile();
        loadBooks();

        // ì±… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadBooks() {
            try {
                const response = await fetch('/api/books');
                const books = await response.json();
                displayBooks(books);
            } catch (error) {
                console.error('ì±… ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('booksList').innerHTML = 
                    '<div class="error">ì±… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì±… ëª©ë¡ í‘œì‹œ
        function displayBooks(books) {
            const filteredBooks = currentFilter === 'all' 
                ? books 
                : books.filter(book => book.difficulty === currentFilter);

            const booksList = document.getElementById('booksList');
            
            if (filteredBooks.length === 0) {
                booksList.innerHTML = '<div class="empty">í•´ë‹¹ ë‚œì´ë„ì˜ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            booksList.innerHTML = filteredBooks.map(book => {
                const difficultyEmoji = {
                    'beginner': 'ğŸŒ±',
                    'intermediate': 'ğŸ“š',
                    'advanced': 'ğŸ“'
                }[book.difficulty] || 'ğŸ“–';
                
                const downloadedBadge = book.is_downloaded 
                    ? '<span class="downloaded-badge" style="background:#10B981; color:white; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.7rem; margin-left:0.5rem;">âœ… ë³´ìœ  ì¤‘</span>' 
                    : '';

                return `
                    <div class="book-card" onclick="showBookModal(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                        <div class="book-cover">
                            <img src="${book.cover_url}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/150x200?text=Book'">
                        </div>
                        <div class="book-info">
                            <h4 class="book-title">${book.title}</h4>
                            <p class="book-author">${book.author}</p>
                            <div style="display:flex; align-items:center; flex-wrap:wrap; gap:0.2rem;">
                                <span class="book-difficulty ${book.difficulty}">
                                    ${difficultyEmoji} ${getDifficultyText(book.difficulty)}
                                </span>
                                ${downloadedBadge}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ë‚œì´ë„ í…ìŠ¤íŠ¸ ë³€í™˜
        function getDifficultyText(difficulty) {
            const texts = {
                'beginner': 'ì´ˆê¸‰',
                'intermediate': 'ì¤‘ê¸‰',
                'advanced': 'ê³ ê¸‰'
            };
            return texts[difficulty] || 'ì¼ë°˜';
        }

        // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.difficulty;
                await loadBooks();
            });
        });

        // ì±… ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
        function showBookModal(book) {
            currentBook = book;
            document.getElementById('modalTitle').textContent = book.title;
            document.getElementById('modalAuthor').textContent = book.author;
            document.getElementById('modalDifficulty').textContent = getDifficultyText(book.difficulty);
            document.getElementById('modalDescription').textContent = book.description;
            document.getElementById('modalCover').src = book.cover_url;
            document.getElementById('bookModal').style.display = 'flex';
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeBookModal() {
            document.getElementById('bookModal').style.display = 'none';
        }

        // ì±… ë‹¤ìš´ë¡œë“œ ë° ì½ê¸°
        async function downloadAndReadBook() {
            if (!currentBook) return;

            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'ğŸ“¥ ë‹¤ìš´ë¡œë“œ ì¤‘...';

            try {
                // ì´ë¯¸ ë‹¤ìš´ë¡œë“œëœ ì±…ì¸ì§€ í™•ì¸
                if (currentBook.id) {
                    window.location.href = `/reader/${currentBook.id}`;
                    return;
                }

                // ì±… ë‹¤ìš´ë¡œë“œ
                const response = await fetch('/api/books/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gutenberg_id: currentBook.gutenberg_id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('ğŸ“š ì±…ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    setTimeout(() => {
                        window.location.href = `/reader/${result.book_id}`;
                    }, 500);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showNotification('âŒ ì±…ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'ğŸ“¥ ë‹¤ì‹œ ì‹œë„';
            }
        }
    </script>
</body>
</html>


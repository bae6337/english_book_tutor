<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <title>ğŸ“ ë‚˜ì˜ ë‹¨ì–´ì¥ - English Book Tutor</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <div class="header-content">
                <a href="/" class="back-btn">â† ë’¤ë¡œ</a>
                <h1 class="page-title">ğŸ“ ë‚˜ì˜ ë‹¨ì–´ì¥</h1>
                <div class="level-badge small">
                    <span class="level-text">Lv.<span id="userLevel">1</span></span>
                </div>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- í†µê³„ -->
            <section class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“</div>
                        <div class="stat-value" id="totalWords">0</div>
                        <div class="stat-label">ì´ ë‹¨ì–´ ìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-value" id="learnedWords">0</div>
                        <div class="stat-label">í•™ìŠµ ì™„ë£Œ</div>
                    </div>
                </div>
            </section>

            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <section class="filter-section">
                <input type="text" id="searchInput" placeholder="ğŸ” ë‹¨ì–´ ê²€ìƒ‰..." 
                       style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
            </section>

            <!-- ë‹¨ì–´ ëª©ë¡ -->
            <section class="vocab-section">
                <h3 class="section-title">í•™ìŠµ ì¤‘ì¸ ë‹¨ì–´</h3>
                <div class="vocab-list" id="vocabList">
                    <div class="loading">ë‹¨ì–´ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </section>

            <!-- ë³µìŠµ ëª¨ë“œ ë²„íŠ¼ -->
            <div class="action-buttons">
                <button class="btn btn-primary btn-large" onclick="startQuiz()">
                    ğŸ¯ ë‹¨ì–´ í€´ì¦ˆ ì‹œì‘
                </button>
            </div>
        </main>

        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bottom-nav">
            <a href="/" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">í™ˆ</span>
            </a>
            <a href="/library" class="nav-item">
                <span class="nav-icon">ğŸ“š</span>
                <span class="nav-label">ë„ì„œê´€</span>
            </a>
            <a href="/vocabulary" class="nav-item active">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-label">ë‹¨ì–´ì¥</span>
            </a>
            <a href="#" class="nav-item" onclick="alert('ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤!'); return false;">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">í†µê³„</span>
            </a>
        </nav>
    </div>

    <!-- í€´ì¦ˆ ëª¨ë‹¬ -->
    <div class="modal" id="quizModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¯ ë‹¨ì–´ í€´ì¦ˆ</h3>
                <button class="modal-close" onclick="closeQuiz()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="quizContent">
                    <h4 style="font-size: 2rem; text-align: center; margin-bottom: 2rem;" id="quizWord">Word</h4>
                    <div id="quizOptions" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- ì„ íƒì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div id="quizResult" style="margin-top: 1rem; text-align: center; display: none;">
                        <p id="resultText" style="font-size: 1.2rem; font-weight: bold;"></p>
                        <button class="btn btn-primary" onclick="nextQuizQuestion()" style="margin-top: 1rem;">
                            ë‹¤ìŒ ë¬¸ì œ
                        </button>
                    </div>
                </div>
                <div id="quizComplete" style="display: none; text-align: center;">
                    <h3 style="font-size: 2rem; margin-bottom: 1rem;">ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!</h3>
                    <p style="font-size: 1.3rem; color: var(--primary-color); margin-bottom: 2rem;">
                        ì ìˆ˜: <span id="finalScore">0</span> / <span id="totalQuestions">0</span>
                    </p>
                    <button class="btn btn-primary" onclick="closeQuiz()">ì™„ë£Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let vocabulary = [];
        let filteredVocab = [];
        let quizWords = [];
        let currentQuizIndex = 0;
        let quizScore = 0;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        loadUserProfile();
        loadVocabulary();

        async function loadVocabulary() {
            try {
                const response = await fetch('/api/vocabulary');
                vocabulary = await response.json();
                filteredVocab = vocabulary;
                displayVocabulary();
                updateStats();
            } catch (error) {
                console.error('ë‹¨ì–´ì¥ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('vocabList').innerHTML = 
                    '<div class="error">ë‹¨ì–´ì¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        function displayVocabulary() {
            const vocabList = document.getElementById('vocabList');
            
            if (filteredVocab.length === 0) {
                vocabList.innerHTML = '<div class="empty">ì•„ì§ ì¶”ê°€í•œ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì±…ì„ ì½ìœ¼ë©´ì„œ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>';
                return;
            }

            vocabList.innerHTML = filteredVocab.map(vocab => `
                <div class="vocab-card">
                    <div class="vocab-word" onclick="speakText('${vocab.word}')" style="cursor: pointer;">
                        ğŸ”Š ${vocab.word}
                    </div>
                    <div class="vocab-translation">${vocab.translation || 'ë²ˆì—­ ì—†ìŒ'}</div>
                    ${vocab.example_sentence ? `<div class="vocab-example">"${vocab.example_sentence}"</div>` : ''}
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalWords').textContent = vocabulary.length;
            document.getElementById('learnedWords').textContent = vocabulary.filter(v => v.learned).length;
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredVocab = vocabulary.filter(vocab => 
                vocab.word.toLowerCase().includes(searchTerm) ||
                (vocab.translation && vocab.translation.toLowerCase().includes(searchTerm))
            );
            displayVocabulary();
        });

        // í€´ì¦ˆ ì‹œì‘
        function startQuiz() {
            if (vocabulary.length < 4) {
                showNotification('í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ ìµœì†Œ 4ê°œì˜ ë‹¨ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // ëœë¤ìœ¼ë¡œ 10ê°œ ë‹¨ì–´ ì„ íƒ (ë˜ëŠ” ì „ì²´)
            quizWords = vocabulary.sort(() => Math.random() - 0.5).slice(0, Math.min(10, vocabulary.length));
            currentQuizIndex = 0;
            quizScore = 0;

            document.getElementById('quizModal').style.display = 'flex';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('quizComplete').style.display = 'none';
            
            showQuizQuestion();
        }

        function showQuizQuestion() {
            if (currentQuizIndex >= quizWords.length) {
                showQuizComplete();
                return;
            }

            const currentWord = quizWords[currentQuizIndex];
            document.getElementById('quizWord').textContent = currentWord.word;
            
            // ì˜¤ë‹µ ì„ íƒì§€ ìƒì„± (ë‹¤ë¥¸ ë‹¨ì–´ë“¤ì˜ ë²ˆì—­)
            const wrongAnswers = vocabulary
                .filter(v => v.id !== currentWord.id && v.translation)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(v => v.translation);
            
            // ì •ë‹µê³¼ ì„ê¸°
            const options = [currentWord.translation, ...wrongAnswers]
                .sort(() => Math.random() - 0.5);
            
            const optionsHtml = options.map((option, index) => `
                <button class="btn btn-secondary" onclick="checkAnswer('${option}', '${currentWord.translation}')" 
                        style="font-size: 1.1rem; padding: 1rem;">
                    ${option}
                </button>
            `).join('');
            
            document.getElementById('quizOptions').innerHTML = optionsHtml;
            document.getElementById('quizResult').style.display = 'none';
        }

        function checkAnswer(selected, correct) {
            const isCorrect = selected === correct;
            
            if (isCorrect) {
                quizScore++;
                document.getElementById('resultText').textContent = 'âœ… ì •ë‹µì…ë‹ˆë‹¤!';
                document.getElementById('resultText').style.color = 'var(--secondary-color)';
            } else {
                document.getElementById('resultText').textContent = `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${correct}`;
                document.getElementById('resultText').style.color = 'var(--danger-color)';
            }
            
            document.getElementById('quizOptions').style.display = 'none';
            document.getElementById('quizResult').style.display = 'block';
        }

        function nextQuizQuestion() {
            currentQuizIndex++;
            document.getElementById('quizOptions').style.display = 'flex';
            showQuizQuestion();
        }

        function showQuizComplete() {
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('quizComplete').style.display = 'block';
            document.getElementById('finalScore').textContent = quizScore;
            document.getElementById('totalQuestions').textContent = quizWords.length;
            
            // ê²½í—˜ì¹˜ ì§€ê¸‰
            const expGained = quizScore * 20;
            updateReadingProgress(expGained / 10);
            
            showNotification(`ğŸ‰ í€´ì¦ˆ ì™„ë£Œ! ${expGained} ê²½í—˜ì¹˜ íšë“!`, 'success');
        }

        function closeQuiz() {
            document.getElementById('quizModal').style.display = 'none';
        }
    </script>
</body>
</html>

